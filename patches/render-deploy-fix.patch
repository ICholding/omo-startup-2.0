From 8f0da2b503fa3602e14aac6dce5bb6294a3119cf Mon Sep 17 00:00:00 2001
From: Codex <codex@openai.com>
Date: Thu, 12 Feb 2026 01:38:12 +0000
Subject: [PATCH] Stabilize socket handler flow and add source validation guard

---
 backend/package.json               |  5 ++-
 backend/scripts/validate-source.js | 27 ++++++++++++
 backend/socket-handler.js          | 67 +++++++++++-------------------
 3 files changed, 55 insertions(+), 44 deletions(-)
 create mode 100644 backend/scripts/validate-source.js

diff --git a/backend/package.json b/backend/package.json
index 243715f..f23bb2d 100644
--- a/backend/package.json
+++ b/backend/package.json
@@ -24,7 +24,7 @@
       "build",
       "serve"
     ],
-    "warning": "ðŸš¨ CRITICAL: DO NOT REMOVE OR MODIFY ABOVE DEPENDENCIES - Required for app functionality"
+    "warning": "\ud83d\udea8 CRITICAL: DO NOT REMOVE OR MODIFY ABOVE DEPENDENCIES - Required for app functionality"
   },
   "dependencies": {
     "@dhiwise/component-tagger": "^1.0.14",
@@ -72,7 +72,8 @@
     "build": "vite build --sourcemap",
     "serve": "vite preview",
     "start:prod": "node server.js",
-    "dev:fullstack": "concurrently \"npm start\" \"node server.js\""
+    "dev:fullstack": "concurrently \"npm start\" \"node server.js\"",
+    "validate:source": "node scripts/validate-source.js"
   },
   "eslintConfig": {
     "extends": [
diff --git a/backend/scripts/validate-source.js b/backend/scripts/validate-source.js
new file mode 100644
index 0000000..809deb7
--- /dev/null
+++ b/backend/scripts/validate-source.js
@@ -0,0 +1,27 @@
+#!/usr/bin/env node
+const fs = require('fs');
+const path = require('path');
+const { execSync } = require('child_process');
+
+const filesToCheck = [
+  'backend/socket-handler.js',
+  'backend/server.js',
+  'backend/agent-core/agent-orchestrator.js'
+];
+
+const diffMarkerPattern = /^(diff --git |@@ |\+\+\+ |--- )/m;
+const conflictPattern = /^(<<<<<<<|=======|>>>>>>>)/m;
+
+for (const relFile of filesToCheck) {
+  const fullPath = path.join(process.cwd(), relFile);
+  const source = fs.readFileSync(fullPath, 'utf8');
+
+  if (diffMarkerPattern.test(source) || conflictPattern.test(source)) {
+    console.error(`Validation failed: patch/conflict markers found in ${relFile}`);
+    process.exit(1);
+  }
+
+  execSync(`node --check ${relFile}`, { stdio: 'pipe' });
+}
+
+console.log('Source validation passed (no patch/conflict markers, syntax OK).');
diff --git a/backend/socket-handler.js b/backend/socket-handler.js
index 2b10416..72a8ba4 100644
--- a/backend/socket-handler.js
+++ b/backend/socket-handler.js
@@ -202,46 +202,29 @@ class SocketHandler {
     const lowerMsg = message.toLowerCase();
     const thoughts = [];
     const githubUrl = this.extractGithubUrl(message);
-    
-    // Initial analysis
-    thoughts.push(`> Analyzing user input: "${message.substring(0, 50)}${message.length > 50 ? '...' : ''}"`);
-    thoughts.push(`> Context length: ${context.length} previous messages`);
-    
-    // Intent detection
+
+    thoughts.push(`> Input analyzed (${context.length} prior messages in context)`);
+
     if (githubUrl) {
-      thoughts.push('> Detected: GitHub repository URL in user message');
-      thoughts.push('> Strategy: Offer clear next actions (files, dependencies, security review)');
-      thoughts.push('> Response style: Conversational and low-friction follow-up question');
-    } else if (lowerMsg.includes('hello') || lowerMsg.includes('hi')) {
-      thoughts.push('> Detected: Greeting/Introduction intent');
-      thoughts.push('> Strategy: Introduce HackerAI capabilities and modes');
-      thoughts.push('> Expected outcome: User provides target or asks for help');
-    } else if (lowerMsg.includes('gpt') || lowerMsg.includes('model') || lowerMsg.includes('ai')) {
-      thoughts.push('> Detected: Identity/Architecture inquiry');
-      thoughts.push('> Strategy: Provide concise identity answer, then ask a useful follow-up');
-      thoughts.push('> Key points: capability summary + clear next step');
+      thoughts.push('> Intent: Repository assistance');
+      thoughts.push('> Action: Offer scan, dependency review, or file walkthrough choices');
+    } else if (this.detectCommandIntent(message) === 'subfinder') {
+      thoughts.push('> Intent: Command-style recon request');
+      thoughts.push('> Action: Confirm domain format and authorization before execution');
+    } else if (lowerMsg.includes('scan') || lowerMsg.includes('check')) {
+      thoughts.push('> Intent: Scanning request');
+      thoughts.push('> Action: Offer default quick scan path with minimal required input');
     } else if (lowerMsg.includes('help') || lowerMsg.includes('what can you do')) {
-      thoughts.push('> Detected: Capability inquiry');
-      thoughts.push('> Strategy: List all 6 operational modes with descriptions');
-      thoughts.push('> Include: Commands reference (/mode, /status, /tools)');
-    } else if (lowerMsg.includes('scan') || lowerMsg.includes('check') || lowerMsg.includes('target')) {
-      thoughts.push('> Detected: Security assessment request');
-      thoughts.push('> Strategy: Confirm intent and suggest default scan options');
-      thoughts.push('> Provide: concise options to reduce user effort');
-    } else if (lowerMsg.includes('time') || lowerMsg.includes('date')) {
-      thoughts.push('> Detected: General knowledge query');
-      thoughts.push('> Strategy: Clarify HackerAI is not a general assistant');
-      thoughts.push('> Redirect: Emphasize security testing specialization');
+      thoughts.push('> Intent: Capability discovery');
+      thoughts.push('> Action: Provide concise defaults (scan/analyze/list/help)');
     } else {
-      thoughts.push('> Detected: Unclear/General inquiry');
-      thoughts.push('> Strategy: Clarify purpose and request specific parameters');
-      thoughts.push('> Need: Target, mode, objective for security testing');
+      thoughts.push('> Intent: General conversation');
+      thoughts.push('> Action: Ask one focused follow-up and avoid rigid command requirements');
     }
-    
-    // Confidence assessment
-    thoughts.push(`> Confidence: ${this.assessConfidence(lowerMsg)}%`);
-    thoughts.push('> Ready to generate response');
-    
+
+    thoughts.push(`> Confidence: ${this.assessConfidence(message)}%`);
+    thoughts.push('> Ready to respond');
+
     return thoughts;
   }
 
@@ -249,13 +232,13 @@ class SocketHandler {
    * Assess confidence level for intent detection
    */
   assessConfidence(message) {
+    const lowerMsg = message.toLowerCase();
     if (this.extractGithubUrl(message)) return 95;
-    if (message.includes('hello') || message.includes('hi')) return 95;
-    if (message.includes('gpt') || message.includes('model')) return 90;
-    if (message.includes('help')) return 85;
-    if (message.includes('scan') || message.includes('check')) return 80;
-    if (message.includes('time') || message.includes('date')) return 70;
-    return 45;
+    if (this.detectCommandIntent(message) === 'subfinder') return 90;
+    if (lowerMsg.includes('scan') || lowerMsg.includes('check')) return 85;
+    if (lowerMsg.includes('help') || lowerMsg.includes('what can you do')) return 85;
+    if (lowerMsg.includes('hello') || lowerMsg.includes('hi')) return 80;
+    return 65;
   }
 
   /**
-- 
2.43.0

