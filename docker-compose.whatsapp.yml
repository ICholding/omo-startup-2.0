version: "3.8"

# WhatsApp ClawBot Integration for omo-startup-2.0

services:
  # OpenClaw Gateway (WhatsApp-focused)
  whatsapp-clawbot:
    image: ghcr.io/icholding/omo-startup-2.0/clawbot-whatsapp:latest
    container_name: omo-whatsapp-clawbot
    restart: unless-stopped
    
    environment:
      - NODE_ENV=production
      - HOME=/home/openclaw
      - TERM=xterm-256color
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OPENCLAW_GATEWAY_BIND=0.0.0.0
      - OPENCLAW_GATEWAY_PORT=18789
      # WhatsApp Only
      - WHATSAPP_ENABLED=true
      - TELEGRAM_ENABLED=false
      - DISCORD_ENABLED=false
      - SLACK_ENABLED=false
      - SIGNAL_ENABLED=false
      # AI Provider
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      
    volumes:
      - whatsapp-data:/home/openclaw/.openclaw
      
    ports:
      - "18789:18789"
      
    networks:
      - omo-network
      
    healthcheck:
      test: ["CMD", "node", "dist/index.js", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # WhatsApp Bridge Service
  whatsapp-bridge:
    build:
      context: ./whatsapp-integration
      dockerfile: Dockerfile.bridge
    container_name: omo-whatsapp-bridge
    restart: unless-stopped
    
    environment:
      - NODE_ENV=production
      - PORT=8081
      - OPENCLAW_GATEWAY_URL=http://whatsapp-clawbot:18789
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OMO_BACKEND_URL=http://backend:8080
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      
    ports:
      - "8081:8081"
      
    networks:
      - omo-network
      
    depends_on:
      - whatsapp-clawbot
      - backend
      
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # OpenClaw CLI for management
  whatsapp-cli:
    image: ghcr.io/icholding/omo-startup-2.0/clawbot-whatsapp:latest
    container_name: omo-whatsapp-cli
    environment:
      - HOME=/home/openclaw
      - TERM=xterm-256color
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OPENCLAW_GATEWAY_URL=http://whatsapp-clawbot:18789
    volumes:
      - whatsapp-data:/home/openclaw/.openclaw
    networks:
      - omo-network
    profiles:
      - cli
    stdin_open: true
    tty: true
    entrypoint: ["node", "dist/index.js"]

volumes:
  whatsapp-data:
    driver: local

networks:
  omo-network:
    external: true
