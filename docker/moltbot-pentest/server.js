const express = require('express');

const app = express();
app.use(express.json());

// Logging middleware
app.use((req, res, next) => {
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.url}`);
  next();
});

const buildExecutionPackage = (message = '') => ({
  status: 'completed',
  summary: `Moltbot sandbox received: ${message}`,
  sections: {
    Runtime: 'This response is served by docker/moltbot-pentest.'
  },
  nextActions: ['Run authorized pentest tasks only.']
});

app.get('/', (req, res) => {
  res.json({ status: 'ok', service: 'moltbot-pentest', version: '1.0.0' });
});

app.get('/health', (req, res) => {
  res.json({ status: 'ok', service: 'moltbot-pentest' });
});

app.post('/api/chat/message', (req, res) => {
  const { message } = req.body || {};
  res.json(buildExecutionPackage(message || ''));
});

app.get('/api/chat/stream', (req, res) => {
  const { message = '', sessionId } = req.query || {};

  if (!sessionId) {
    return res.status(400).json({ error: 'sessionId is required' });
  }

  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');

  const writeEvent = (event, data) => {
    res.write(`event: ${event}\n`);
    res.write(`data: ${JSON.stringify(data)}\n\n`);
  };

  writeEvent('execution-start', { state: 'thinking', message: 'Thinking...' });

  setTimeout(() => {
    writeEvent('execution-complete', buildExecutionPackage(String(message || '')));
    writeEvent('done', { ok: true });
    res.end();
  }, 50);
});

// 404 handler for debugging
app.use((req, res) => {
  console.log(`[404] Route not found: ${req.method} ${req.url}`);
  res.status(404).json({ error: 'Not Found', path: req.url, method: req.method });
});

const port = process.env.PORT || 8080;
app.listen(port, '0.0.0.0', () => {
  console.log(`moltbot-pentest listening on ${port}`);
});
