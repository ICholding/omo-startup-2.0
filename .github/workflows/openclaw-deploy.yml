name: Deploy OpenClaw + omo-startup-2.0

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      configure_channels:
        description: 'Configure messaging channels'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/openclaw

jobs:
  deploy:
    name: Deploy Stack
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          echo "DEPLOY_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
      
      - name: Create environment file
        env:
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          VECTORDB_PASSWORD: ${{ secrets.VECTORDB_PASSWORD }}
        run: |
          cat > .env << EOF
          # OpenClaw Configuration
          OPENCLAW_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-}
          OPENCLAW_GATEWAY_BIND=lan
          OPENCLAW_GATEWAY_PORT=18789
          OPENCLAW_BRIDGE_PORT=18790
          OPENCLAW_CANVAS_PORT=18793
          
          # Frontend Configuration
          FRONTEND_PORT=3000
          BACKEND_PORT=8080
          
          # AI Provider Keys
          OPENAI_API_KEY=${OPENAI_API_KEY:-}
          ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
          
          # Channel Configuration
          WHATSAPP_ENABLED=true
          TELEGRAM_ENABLED=${TELEGRAM_BOT_TOKEN:+true}
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
          DISCORD_ENABLED=${DISCORD_BOT_TOKEN:+true}
          DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
          SLACK_ENABLED=${SLACK_BOT_TOKEN:+true}
          SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
          
          # Database
          POSTGRES_USER=omo
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-}
          POSTGRES_DB=omo_startup
          
          # Vector DB
          VECTORDB_PASSWORD=${VECTORDB_PASSWORD:-}
          EOF
      
      - name: Deploy to Render (OpenClaw Service)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_OPENCLAW_SERVICE_ID: ${{ secrets.RENDER_OPENCLAW_SERVICE_ID }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_OPENCLAW_SERVICE_ID" ]; then
            echo "Triggering OpenClaw deployment on Render..."
            curl -X POST \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              https://api.render.com/v1/services/$RENDER_OPENCLAW_SERVICE_ID/deploys
            echo "OpenClaw deployment triggered!"
          else
            echo "Render OpenClaw service not configured. Set RENDER_API_KEY and RENDER_OPENCLAW_SERVICE_ID secrets."
          fi
      
      - name: Deploy to Render (Backend Service)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_BACKEND_SERVICE_ID: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_BACKEND_SERVICE_ID" ]; then
            echo "Triggering Backend deployment on Render..."
            curl -X POST \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              https://api.render.com/v1/services/$RENDER_BACKEND_SERVICE_ID/deploys
            echo "Backend deployment triggered!"
          else
            echo "Render Backend service not configured. Set RENDER_API_KEY and RENDER_BACKEND_SERVICE_ID secrets."
          fi
      
      - name: Deploy to Render (Frontend Service)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_FRONTEND_SERVICE_ID: ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}
        run: |
          if [ -n "$RENDER_API_KEY" ] && [ -n "$RENDER_FRONTEND_SERVICE_ID" ]; then
            echo "Triggering Frontend deployment on Render..."
            curl -X POST \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              -H "Content-Type: application/json" \
              https://api.render.com/v1/services/$RENDER_FRONTEND_SERVICE_ID/deploys
            echo "Frontend deployment triggered!"
          else
            echo "Render Frontend service not configured. Set RENDER_API_KEY and RENDER_FRONTEND_SERVICE_ID secrets."
          fi
      
      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Channels Configured**: ${{ github.event.inputs.configure_channels }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Render Services" >> $GITHUB_STEP_SUMMARY
          echo "- OpenClaw Gateway: Check Render dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- Backend (omo-startup-backend): Check Render dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend (omo-startup): Check Render dashboard" >> $GITHUB_STEP_SUMMARY
